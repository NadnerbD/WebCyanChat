<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Console</title>
		<script type="text/javascript">
			var sock;
			var width = 0;
			var height = 0;
			var modCtrl = false;
			var grid = new Array();
			var appkeymode = false;
			var firstInit = true;
			var cursor;

			var colors = [
				"black",
				"red",
				"green",
				"yellow",
				"blue",
				"magenta",
				"cyan",
				"white"
			];

			function unpackStyle(value) {
				return {
					bold:              value        & 0x01 ,
					bgBold:           (value >>  1) & 0x01 ,
					underline:        (value >>  2) & 0x01 ,
					italic:           (value >>  3) & 0x01 ,
					inverted:         (value >>  4) & 0x01 ,
					color:     colors[(value >>  8) & 0x0F],
					backg:     colors[(value >> 12) & 0x0F]
				};
			}

			function applyStyle(elem, value) {
				var style = unpackStyle(value);
				for(var s in style) {
					for(var c of elem.classList) if(c.startsWith(s)) elem.classList.remove(c);
					if(typeof(style[s]) == "number") {
						if(style[s]) elem.classList.add(s);
					}else if(style[s] != undefined) {
						elem.classList.add(s + "-" + style[s]);
					}
				}
			}

			function createGrid(container) {
				var cells = new Array();
				var list = document.createElement("ul");
				for(var y = 0; y < height; y++) {
					var line = document.createElement("li");
					for(var x = 0; x < width; x++) {
						var cell = document.createElement("span");
						var char = document.createTextNode(" ");
						cell.appendChild(char);
						line.appendChild(cell);
						cells.push(cell);
					}
					list.appendChild(line);
				}
				container.appendChild(list);
				return cells;
			}

			function setCursor(index) {
				if(cursor)
					cursor.classList.remove("cursor");
				if(index != -1) {
					cursor = grid[index];
					cursor.classList.add("cursor");
				}
			}

			function init() {
				document.addEventListener("keydown", keydown, false);
				document.addEventListener("paste", handlePaste, false);
				window.addEventListener("resize", handleResize, false);

				setTheme(localStorage.getItem("consoleTheme") || "default");

				sock = new WebSocket((window.location.protocol=="https:"?"wss://":"ws://") + window.location.host + "/web-socket", "term");
				sock.binaryType = "arraybuffer";
				MSG_BADPASS = 0;
				MSG_MODES = 1;
				MSG_INIT = 2;
				MSG_DIFF = 3;
				MSG_TITLE = 4;
				DIFF_CHAR = 0;
				DIFF_SHIFT = 1;
				DIFF_NEXT_CHAR = 2;
				DIFF_NEXT_CHAR_NOSTYLE = 3;
				sock.onmessage = function (msgEvent) {
					var dv = new DataView(msgEvent.data);
					var cmd = dv.getUint8(0);
					switch(cmd) {
					case MSG_BADPASS:
						alert("Server rejected password");
						deleteCookie("term_pass");
						break;
					case MSG_MODES:
						var modes = dv.getUint8(1);
						appkeymode = modes & 0x01;
						document.body.className = modes & 0x02 ? "inverted" : "";
						break;
					case MSG_TITLE:
						var dc = new TextDecoder("utf-8");
						document.title = dc.decode(new Uint8Array(msgEvent.data, 1, msgEvent.data.byteLength - 1));
						break;
					case MSG_INIT:
						var mWidth = dv.getInt16(1);
						var mHeight = dv.getInt16(3);
						// console.log("INIT " + mWidth + " " + mHeight);
						var mCursor = dv.getInt32(5);
						if(width != mWidth || height != mHeight) {
							var container = document.getElementById("grid");
							while(container.childNodes.length)
								container.removeChild(container.firstChild);
							width = mWidth;
							height = mHeight;
							grid = createGrid(container);
							cursor = grid[mCursor];
						}
						for(var i = 0; i < width * height; i++) {
							grid[i].firstChild.data = String.fromCharCode(dv.getUint16(9 + 4 * i));
							applyStyle(grid[i], dv.getUint16(11 + 4 * i));
						}
						setCursor(mCursor);
						if(firstInit) {
							sizeToWindow();
							firstInit = false;
						}
						break;
					case MSG_DIFF:
						var mCursor = dv.getInt32(1);
						var mOffset = 5;
						// var LOGMSG = [];
						var chPos = 0;
						var chStyle = 0;
						while(mOffset < msgEvent.data.byteLength) {
							var chType = dv.getUint8(mOffset++);
							switch(chType) {
							case DIFF_CHAR:
								var chPos = dv.getInt32(mOffset);
								mOffset += 4;
							case DIFF_NEXT_CHAR:
								var chStyle = dv.getUint16(mOffset);
								mOffset += 2;
							case DIFF_NEXT_CHAR_NOSTYLE:
								var chChar = String.fromCharCode(dv.getUint16(mOffset));
								mOffset += 2;
								// LOGMSG.push("char: " + JSON.stringify([chPos, chStyle, chChar]));
								grid[chPos].firstChild.data = chChar;
								applyStyle(grid[chPos], chStyle);
								chPos++;
								break;
							case DIFF_SHIFT:
								var start = dv.getInt32(mOffset);
								var end = dv.getInt32(mOffset + 4);
								var offset = dv.getInt32(mOffset + 8);
								mOffset += 12;
								// LOGMSG.push("shift: " + JSON.stringify([start, end, offset]));
								var srcgrid = grid.slice(start, end).map(e => [e.firstChild.data, e.className]);
								var index = Math.min(start + offset, start);
								while(index < Math.max(end + offset, end) && index < grid.length) {
									if(index < start + offset || index >= end + offset) {
										grid[index].firstChild.data = " ";
										grid[index].className = "";
									}else{
										var src = srcgrid[index - start - offset];
										grid[index].firstChild.data = src[0];
										grid[index].className = src[1];
										grid[index].classList.remove("cursor");
									}
									index++;
								}
								break;
							}
						}
						setCursor(mCursor);
						// console.log(LOGMSG);
						break;
					}
				}
				sock.onopen = function () {
					var passwd = getCookie("term_pass");
					if(passwd == "") {
						passwd = prompt("Enter your password", "");
						setCookie("term_pass", passwd);
					}
					sock.send(passwd);
				}
				sock.onclose = function () {
					window.close();
				}
			}

			function setCookie(name, value) {
				// cookies are set to expire in one week
				var today = new Date();
				expire_date = new Date(today.getTime() + (7 * 1000 * 60 * 60 * 24));
				expire_string = expire_date.toGMTString();
				document.cookie = name + "=" + escape(value) + ";path=/;expires=" + expire_string;
			}

			function getCookie(name) {
				// first check if the cookie exists
				if(document.cookie.split(name + "=").length > 1) {
					// if so, extract it
					return unescape(document.cookie.split(name + "=")[1].split(";")[0]);
				}else{
					// otherwise return an empty string
					return "";
				}
			}

			function deleteCookie(name) {
				// we delete cookies by setting their expiry date to the past
				today = new Date();
				expire_string = new Date(today.getTime() - 1).toGMTString();
				document.cookie = name + "=;path=/;expires=" + expire_string
			}

			function sendKey(keyCode) {
				var msg = new Uint8Array([107, keyCode]); // 'k'
				sock.send(msg);
				// console.log(String.fromCharCode(keyCode));
			}

			function reqResize(x, y) {
				var msg = new Uint8Array([114, 0, 0, 0, 0]); // 'r'
				var dv = new DataView(msg.buffer);
				dv.setUint16(1, x);
				dv.setUint16(3, y);
				sock.send(msg);
			}

			var cursorCodes = {35: 52, 36: 49, 37: 68, 38: 65, 39: 67, 40: 66, 33: 53, 34: 54, 45: 50, 46: 51}; // 41DACB5623
			function keydown(event) {
				// directional and special keys will only be
				// picked up here
				//console.log(event.which);
				handled = true;
				switch(event.which) {
					// cursor keys
					case 37: // left
					case 38: // up
					case 39: // right
					case 40: // down
						sendKey(27); // Esc
						if(appkeymode) {
							sendKey(79); // O (application mode)
						}else{
							sendKey(91); // [ (normal mode)
						}
						sendKey(cursorCodes[event.which]);
						break;
					// editing keys
					case 33: // pg up
					case 34: // pg down
					case 35: // end
					case 36: // home
					case 45: // insert
					case 46: // del
						sendKey(27); // Esc
						sendKey(91); // [
						sendKey(cursorCodes[event.which]);
						sendKey(126); // ~
						break;
					case 8: // Backspace
						sendKey(127); // 0x7F (ASCII DEL)
						break;
					case 112: // F1
					case 113: // F2
					case 114: // F3
					case 115: // F4
						sendKey(27); // Esc
						sendKey(79); // O
						sendKey(event.which - 32);
						break;
					case 116: // F5
						sendKey(27); // Esc
						sendKey(91); // [
						sendKey(49); // 1
						sendKey(53); // 5
						sendKey(126); // ~
						break;
					case 117: // F6
					case 118: // F7
					case 119: // F8
					case 120: // F9
					case 121: // F10
						sendKey(27); // Esc
						sendKey(91); // [
						for(var digit of (event.which - 100).toString())
							sendKey(digit.charCodeAt(0));
						sendKey(126); // ~
						break;
					case 122: // F11
					case 123: // F12
						sendKey(27); // Esc
						sendKey(91); // [
						for(var digit of (event.which - 99).toString())
							sendKey(digit.charCodeAt(0));
						sendKey(126); // ~
						break;
					case 9: // Tab
					case 13: // Enter
					case 27: // Esc
						// send key code directly
						sendKey(event.which);
						break;
					case 16: // Shift
					case 17: // Ctrl
					case 20: // Caps Lock
						// don't send anything on modifier key events
						break;
					default: // Send character code for anything we don't recognize
						if(event.ctrlKey && event.key == "v") { // real ctrl-v needs to trigger browser paste event
							handled = false;
							break;
						}
						if(modCtrl || event.ctrlKey) { // ctrl and soft-ctrl
							sendKey(event.which & 0037);
							modCtrl = false;
						}else{
							sendKey(event.key.charCodeAt(0));
						}
						break;
				}
				if(handled) {
					event.preventDefault();
					event.stopPropagation();
				}
			}

			function handlePaste(event) {
				event.stopPropagation();
				event.preventDefault();

				var cData = event.clipboardData || window.clipboardData;
				var data = cData.getData("Text");

				for(var i = 0; i < data.length; i++) {
					sendKey(data.charCodeAt(i));
				}
			}

			function sizeToWindow() {
				var charRect = document.querySelector("#grid span").getBoundingClientRect();
				reqResize(
					Math.floor(window.innerWidth / charRect.width),
					Math.floor(window.innerHeight / charRect.height)
				);
			}

			var resizeTimeout;
			function handleResize(event) {
				clearTimeout(resizeTimeout);
				resizeTimeout = setTimeout(sizeToWindow, 200);
			}

			function setTheme(theme) {
				document.getElementById("theme").href = "console-" + theme + ".css";
				document.getElementById("themeSelect").value = theme;
				localStorage.setItem("consoleTheme", theme);
			}
		</script>
		<style>
			body {
				margin: 0;
			}
			textarea {
				font-family: monospace;
				font-weight: bold;
			}
			#grid ul {
				list-style-type: none;
				padding: 0;
				margin: 0;
			}
			#grid li {
				display: block;
				white-space: nowrap;
				line-height: 1em;
			}
			#grid span {
				font-family: monospace;
				white-space: pre;
				/* prevent weird characters from mis-sizing our grid */
				display: inline-block;
				vertical-align: top;
				width: 1ch;
			}
			div#controls {
				position: fixed;
				top: 0.5em;
				right: 0.5em;
				opacity: 0.5;
			}
			input[value="Ctrl"], select#themeSelect {
				float: right;
				margin-left: 0.5em;
			}
		</style>
		<link id="theme" rel="stylesheet" href="console-default.css">
	</head>
	<body onload="init()">
		<div id="grid"></div>
		<div id="controls">
			<input type="button" value="Ctrl" onclick="modCtrl=true;" onkeyup="event.preventDefault();"/>
			<select id="themeSelect" onchange="setTheme(event.target.value)" >
				<option>default</option>
				<option>solarized</option>
			</select>
		</div>
	</body>
</html>

<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Console</title>
		<script type="text/javascript">
			var sock;
			var width = 0;
			var height = 0;
			var modCtrl = false;
			var grid = new Array();
			var appkeymode = false;
			var cursor;

			var colors = [
				"gray",
				"red",
				"green",
				"yellow",
				"blue",
				"magenta",
				"cyan",
				""
			];
			var bgcolors = [
				"",
				"red",
				"green",
				"yellow",
				"blue",
				"magenta",
				"cyan",
				"white"
			];
			var weights = [
				"normal",
				"bold"
			];
			var decorations = [
				"none",
				"underline"
			]

			function unpackStyle(value) {
				return {
					fontWeight: weights[value & 0x01],
					textDecoration: decorations[(value & (0x01 << 1)) >> 1],
					color: colors[(value & (0x07 << 2)) >> 2],
					backgroundColor: bgcolors[(value & (0x07 << 5)) >> 5]
				};
			}

			function createGrid(container) {
				var cells = new Array();
				var list = document.createElement("ul");
				for(var y = 0; y < height; y++) {
					var line = document.createElement("li");
					for(var x = 0; x < width; x++) {
						var cell = document.createElement("span");
						var char = document.createTextNode(" ");
						cell.appendChild(char);
						line.appendChild(cell);
						cells.push(cell);
					}
					list.appendChild(line);
				}
				container.appendChild(list);
				return cells;
			}

			function setCursor(index) {
				if(cursor)
					cursor.classList.remove("cursor");
				if(index != -1) {
					cursor = grid[index];
					cursor.className = "cursor";
				}
			}

			function init() {
				document.addEventListener("keypress", keypress, false);
				document.addEventListener("keydown", keydown, false);
				document.addEventListener("keyup", keyup, false);
				document.addEventListener("paste", handlePaste, false);

				sock = new WebSocket((window.location.protocol=="https:"?"wss://":"ws://") + window.location.host + "/web-socket", "term");
				sock.binaryType = "arraybuffer";
				MSG_BADPASS = 0;
				MSG_KEYMODE = 1;
				MSG_INIT = 2;
				MSG_DIFF = 3;
				MSG_TITLE = 4;
				DIFF_CHAR = 0;
				DIFF_SHIFT = 1;
				sock.onmessage = function (msgEvent) {
					var dv = new DataView(msgEvent.data);
					var cmd = dv.getUint8(0);
					if(cmd == MSG_BADPASS) {
						alert("Server rejected password");
						deleteCookie("term_pass");
						return;
					}
					if(cmd == MSG_KEYMODE) {
						appkeymode = dv.getUint8(1);
						return;
					}
					if(cmd == MSG_TITLE) {
						var dc = new TextDecoder("utf-8");
						document.title = dc.decode(new Uint8Array(msgEvent.data, 1, msgEvent.data.byteLength - 1));
						return;
					}
					if(cmd == MSG_INIT) {
						var mWidth = dv.getInt16(1);
						var mHeight = dv.getInt16(3);
						var mCursor = dv.getInt32(5);
						if(width != mWidth || height != mHeight) {
							var container = document.getElementById("grid");
							while(container.childNodes.length)
								container.removeChild(container.firstChild);
							width = mWidth;
							height = mHeight;
							grid = createGrid(container);
							cursor = grid[mCursor];
						}
						for(var i = 0; i < width * height; i++) {
							grid[i].firstChild.data = String.fromCharCode(dv.getUint16(9 + 3 * i));
							var style = unpackStyle(dv.getUint8(11 + 3 * i));
							for(var s in style) {
								grid[i].style[s] = style[s];
							}
						}
						setCursor(mCursor);
					}
					if(cmd == MSG_DIFF) {
						var mCursor = dv.getInt32(1);
						var mLen = dv.getInt32(5);
						var mOffset = 9;
						// var LOGMSG = [];
						for(var i = 0; i < mLen; i++) {
							var chType = dv.getUint8(mOffset);
							if(chType == DIFF_CHAR) {
								var chPos = dv.getInt32(mOffset + 1);
								var chChar = String.fromCharCode(dv.getUint16(mOffset + 5));
								var chStyle = dv.getUint8(mOffset + 7);
								mOffset += 8;
								// LOGMSG.push("char: " + JSON.stringify([chChar, String.fromCharCode(chStyle)]));
								grid[chPos].firstChild.data = chChar;
								var style = unpackStyle(chStyle);
								for (var s in style) grid[chPos].style[s] = style[s];
							}else if(chType == DIFF_SHIFT) {
								var start = dv.getInt32(mOffset + 1);
								var end = dv.getInt32(mOffset + 5);
								var offset = dv.getInt32(mOffset + 9);
								mOffset += 13;
								// LOGMSG.push("shift: " + JSON.stringify([start, end, offset]));
								var srcgrid = grid.slice(start, end).map(e => [e.firstChild.data, e.style.cssText]);
								var index = Math.min(start + offset, start);
								while(index < Math.max(end + offset, end) && index < grid.length) {
									if(index < start + offset || index >= end + offset) {
										grid[index].firstChild.data = " ";
										grid[index].style = "";
									}else{
										var src = srcgrid[index - start - offset];
										grid[index].firstChild.data = src[0];
										grid[index].style = src[1];
									}
									index++;
								}
							}
						}
						setCursor(mCursor);
						// console.log(LOGMSG);
					}
				}
				sock.onopen = function () {
					var passwd = getCookie("term_pass");
					if(passwd == "") {
						passwd = prompt("Enter your password", "");
						setCookie("term_pass", passwd);
					}
					sock.send(passwd);
				}
			}

			function setCookie(name, value) {
				// cookies are set to expire in one week
				var today = new Date();
				expire_date = new Date(today.getTime() + (7 * 1000 * 60 * 60 * 24));
				expire_string = expire_date.toGMTString();
				document.cookie = name + "=" + escape(value) + ";path=/;expires=" + expire_string;
			}

			function getCookie(name) {
				// first check if the cookie exists
				if(document.cookie.split(name + "=").length > 1) {
					// if so, extract it
					return unescape(document.cookie.split(name + "=")[1].split(";")[0]);
				}else{
					// otherwise return an empty string
					return "";
				}
			}

			function deleteCookie(name) {
				// we delete cookies by setting their expiry date to the past
				today = new Date();
				expire_string = new Date(today.getTime() - 1).toGMTString();
				document.cookie = name + "=;path=/;expires=" + expire_string
			}

			function keypress(event) {
				// most keypresses will be handled here
				// capitalization and such is handled by the browser
				if(modCtrl && String.fromCharCode(event.which) == "v") return;
				if(modCtrl) {
					sock.send(event.which & 0037);
					modCtrl = false;
				}else{
					sock.send(event.which);
				}
				event.preventDefault();
			}

			var cursorCodes = {35: 52, 36: 49, 37: 68, 38: 65, 39: 67, 40: 66, 33: 53, 34: 54, 45: 50, 46: 51}; // 41DACB5623
			function keydown(event) {
				// directional and special keys will only be
				// picked up here
				//console.log(event.which);
				handled = true;
				switch(event.which) {
					// cursor keys
					case 37: // left
					case 38: // up
					case 39: // right
					case 40: // down
						sock.send(27); // Esc
						if(appkeymode) {
							sock.send(79); // O (application mode)
						}else{
							sock.send(91); // [ (normal mode)
						}
						sock.send(cursorCodes[event.which]);
						break;
					// editing keys
					case 33: // pg up
					case 34: // pg down
					case 35: // end
					case 36: // home
					case 45: // insert
					case 46: // del
						sock.send(27); // Esc
						sock.send(91); // [
						sock.send(cursorCodes[event.which]);
						sock.send(126); // ~
						break;
					case 27: // esc
					case 9: // Tab
						sock.send(event.which);
						break;
					case 8: // Backspace
						sock.send(127); // 0x7F (ASCII DEL)
						break;
					case 17: // Ctrl
						modCtrl = true;
						break;
					default:
						handled = false;
						break;
				}
				if(handled)
					event.preventDefault();
			}

			function keyup(event) {
				if(event.which == 17) {
					modCtrl = false;
					event.preventDefault();
				}
			}

			function handlePaste(event) {
				event.stopPropagation();
				event.preventDefault();

				var cData = event.clipboardData || window.clipboardData;
				var data = cData.getData("Text");

				for(var i = 0; i < data.length; i++) {
					sock.send(data.charCodeAt(i));
				}
			}
		</script>
		<style>
			textarea {
				font-family: monospace;
				font-weight: bold;
			}
			#grid ul {
				list-style-type: none;
				padding: 0px;
				margin: 0px;
			}
			#grid li {
				display: block;
				height: 15px;
				white-space: nowrap;
			}
			#grid span {
				font-family: monospace;
				background-color: black;
				white-space: pre;
				color: white;
				/* prevent weird characters from mis-sizing our grid */
				display: inline-block;
				vertical-align: top;
				height: 15px;
				width: 8px;
			}
			#grid span.cursor {
				color: black;
				background-color: white;
			}
		</style>
	</head>
	<body onload="init()">
		<div id="grid"></div>
		<input type="button" value="Ctrl" onclick="modCtrl=true;" onkeyup="event.preventDefault();"/>
	</body>
</html>

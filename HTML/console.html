<html>
	<head>
		<title>Console</title>
		<script type="text/javascript">
			var sock;
			var width = 0;
			var height = 0;
			var modCtrl = false;
			var grid = new Array();
			var appkeymode = false;
			var cursor;

			var colors = [
				"gray",
				"red",
				"green",
				"yellow",
				"blue",
				"magenta",
				"cyan",
				""
			];
			var bgcolors = [
				"",
				"red",
				"green",
				"yellow",
				"blue",
				"magenta",
				"cyan",
				"white"
			];
			var weights = [
				"normal",
				"bold"
			];
			var decorations = [
				"none",
				"underline"
			]

			function unpackStyle(value) {
				return {
					fontWeight: weights[value & 0x01],
					textDecoration: decorations[(value & (0x01 << 1)) >> 1],
					color: colors[(value & (0x07 << 2)) >> 2],
					backgroundColor: bgcolors[(value & (0x07 << 5)) >> 5]
				};
			}

			function createGrid(container) {
				var cells = new Array();
				for(var y = 0; y < height; y++) {
					for(var x = 0; x < width; x++) {
						var cell = document.createElement("span");
						var char = document.createTextNode(" ");
						cell.appendChild(char);
						container.appendChild(cell);
						cells.push(cell);
					}
					if(y < height - 1) {
						var br = document.createElement("br");
						container.appendChild(br);
					}
				}
				return cells;
			}

			function setCursor(index) {
				if(cursor)
					cursor.className = undefined;
				if(index != -1) {
					cursor = grid[index];
					cursor.className = "cursor";
				}
			}

			function init() {
				document.addEventListener("keypress", keypress, false);
				document.addEventListener("keydown", keydown, false);
				document.addEventListener("keyup", keyup, false);
				document.addEventListener("paste", handlePaste, false);

				sock = new WebSocket((window.location.protocol=="https:"?"wss://":"ws://") + window.location.host + "/web-socket", "term");
				sock.onmessage = function (msgEvent) {
					//console.log(msgEvent.data);
					var msg = JSON.parse(msgEvent.data);
					if(msg.cmd == "badpass") {
						alert("Server rejected password");
						deleteCookie("term_pass");
						return;
					}
					if(msg.cmd == "setkeymode") {
						appkeymode = msg.keymode == "application";
						return;
					}
					if(msg.cmd == "init" && (width != msg.size[0] || height != msg.size[1])) {
						var container = document.getElementById("grid");
						while(container.childNodes.length)
							container.removeChild(container.firstChild);
						width = msg.size[0];
						height = msg.size[1];
						grid = createGrid(container);
						cursor = grid[msg.cur];
					}
					if(msg.cmd == "init" || msg.cmd == "change") {
						for(var i in msg.data) {
							grid[i].firstChild.data = msg.data[i];
							var style = unpackStyle(msg.styles[i].charCodeAt(0));
							for(var s in style) {
								grid[i].style[s] = style[s];
							}
						}
					}
					setCursor(msg.cur);
				}
				sock.onopen = function () {
					var passwd = getCookie("term_pass");
					if(passwd == "") {
						passwd = prompt("Enter your password", "");
						setCookie("term_pass", passwd);
					}
					sock.send(passwd);
				}
			}

			function setCookie(name, value) {
				// cookies are set to expire in one week
				var today = new Date();
				expire_date = new Date(today.getTime() + (7 * 1000 * 60 * 60 * 24));
				expire_string = expire_date.toGMTString();
				document.cookie = name + "=" + escape(value) + ";path=/;expires=" + expire_string;
			}

			function getCookie(name) {
				// first check if the cookie exists
				if(document.cookie.split(name + "=").length > 1) {
					// if so, extract it
					return unescape(document.cookie.split(name + "=")[1].split(";")[0]);
				}else{
					// otherwise return an empty string
					return "";
				}
			}

			function deleteCookie(name) {
				// we delete cookies by setting their expiry date to the past
				today = new Date();
				expire_string = new Date(today.getTime() - 1).toGMTString();
				document.cookie = name + "=;path=/;expires=" + expire_string
			}

			function keypress(event) {
				// most keypresses will be handled here
				// capitalization and such is handled by the browser
				if(modCtrl && String.fromCharCode(event.which) == "v") return;
				if(modCtrl) {
					sock.send(event.which & 0037);
					modCtrl = false;
				}else{
					sock.send(event.which);
				}
				event.preventDefault();
			}

			var cursorCodes = {35: 52, 36: 49, 37: 68, 38: 65, 39: 67, 40: 66, 33: 53, 34: 54, 45: 50, 46: 51}; // 41DACB5623
			function keydown(event) {
				// directional and special keys will only be
				// picked up here
				//console.log(event.which);
				handled = true;
				switch(event.which) {
					// cursor keys
					case 37: // left
					case 38: // up
					case 39: // right
					case 40: // down
						sock.send(27); // Esc
						if(appkeymode) {
							sock.send(79); // O (application mode)
						}else{
							sock.send(91); // [ (normal mode)
						}
						sock.send(cursorCodes[event.which]);
						break;
					// editing keys
					case 33: // pg up
					case 34: // pg down
					case 35: // end
					case 36: // home
					case 45: // insert
					case 46: // del
						sock.send(27); // Esc
						sock.send(91); // [
						sock.send(cursorCodes[event.which]);
						sock.send(126); // ~
						break;
					case 27: // esc
					case 9: // Tab
					case 8: // Backspace
						sock.send(event.which);
						break;
					case 17: // Ctrl
						modCtrl = true;
						break;
					default:
						handled = false;
						break;
				}
				if(handled)
					event.preventDefault();
			}

			function keyup(event) {
				if(event.which == 17) {
					modCtrl = false;
					event.preventDefault();
				}
			}

			function handlePaste(event) {
				event.stopPropagation();
				event.preventDefault();

				var cData = event.clipboardData || window.clipboardData;
				var data = cData.getData("Text");

				for(var i = 0; i < data.length; i++) {
					sock.send(data.charCodeAt(i));
				}
			}
		</script>
		<style>
			textarea {
				font-family: monospace;
				font-weight: bold;
			}
			#grid span {
				font-family: monospace;
				background-color: black;
				white-space: pre;
				color: white;
			}
			#grid span.cursor {
				color: black;
				background-color: white;
			}
		</style>
	</head>
	<body onload="init()">
		<div id="grid"></div>
		<input type="button" value="Ctrl" onclick="modCtrl=true;"/>
	</body>
</html>
